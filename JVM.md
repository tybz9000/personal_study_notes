# JVM

# 类装载子系统

# 类加载过程，类初始化：

javac：词法分析、语法分析、语义分析，之后编译成class文件（字节码）

之后就是类加载进入jvm

##### 加载：

- ​	class文件载入内存
- ​	创建class对象

##### 链接

- 将类的二进制数据合并到JRE中
- ​	验证：写的对不对，有没有安全问题

- ​	准备：为静态变量分配内存，设置初始值


- [ ] ​	解析：将类中的二进制数据中的符号引用替换成直接引用（final修改的常量的替换）


##### 初始化

- [ ] ​	执行类初始化，调用clinit，将静态方法合并到一起


### 什么时候会导致类加载或者类初始化?

- 创建类的实例(new方法)

- 调用某个类的静态方法

- 访问某个类或者接口的静态属性

- 使用反射机制来强制创建某个类或接口对应的java.lang.Class对象。（Class.forName(“Person”)）

- 初始化某个类的子类

- 直接使用java.exe命令来运行某个主类 main


##### 不会的情况

- 子类访问父类静态变量，不会导致初始化

- 引用常量不会初始化

- ​	static 链接阶段就在常量池了



#### 类加载器

1. **Bootstrap classLoader**引导类加载器，负责java核心库

   无法获取

2. **Ext ClassLoader**扩展类加载器，负责jre/lib/ext 或 -D java.ext.dirs

   systemClassLoader.getParent()

3. **App ClassLoader**系统类加载器，负责 java-classpath 或者 -D java.class.path

   ClassLoader systemClassLoader = ClassLoader.getSystemClasssLoader();

#### 双亲委派机制

保证类加载按顺序进行，不会有人能篡改底层类加载器数据

# 运行时数据区

![](D:\学习文件3\图片\88e60f28a895442d8846ad0e87739184.png)

#### 元空间（方法区、永久代）

常量

静态变量

类元信息：类被类装载子系统加载到这里

1.8之后使用物理内存

#### 堆

##### 年轻代

- 伊甸园区Eden【默认1/10】
- Survivor区 From To
  - 幸存者0
  - 幸存者1
- 老年代

#### 程序计数器

线程马上要执行的JVM指令码的内存位置

线程独享

#### 栈

java虚拟机栈

线程私有

每个方法执行时创建栈帧。

##### 栈帧

局部变量表：局部变量的值

操作数栈：运算时的操作数

动态链接：方法里的符号的指令码，执行过来后，该执行哪些指令码。指向方法区

方法出口：执行完后，应该执行到上一个方法的哪一步

#### 本地方法栈

线程独享，需要调用的本地方法

# GC

#### JVM堆经典布局

- 新生代

  - Eden：新生的对象在此创建
  - S0：Survivor0
  - S1：Survivor1

- 老年代

  JVM垃圾回收过程

- Major GC
- Full GC

#### GC算法

##### 引用计数法

- 比较老了
- 现在的JVM一般不采用这种GC算法
  - 有新引用指向它，那么计数加一
  - 超过生命周期，计数减一
  - 有引用不再指向它，计数减一
- 优点：没有STW
- 缺点：运行时效率低
- 缺点：无法处理循环依赖

##### 可达性分析

引用：有人用

通过对GC Root对象做可达性分析，从GC Root对象开始，**向下搜索**（向内搜索），形成的路径被称为引用链，如果一个对象到GC ROOT没有任何引用，没有形成引用链，那么该对象等待GC回收。

GC Root根：

- Class对象，由BootstrapClassLoader加载的对象是不能被回收的
- Thread，活动的线程
- sychronzied引用的对象
- 虚拟机栈中引用的对象（局部变量表）
  - 比如某段代码块结束，虚拟机栈出栈，GC Root消失

- static，方法区中类静态属性引用的对象
- final，常量引用，方法区中常量引用的对象
- native，本地方法栈的变量

顺着GC Root根的引用去找，没被引用的干掉

#### 具体执行：

被定义为垃圾对象后，并不会马上被回收

定义为不可达对象后，进行一次标记，然后执行一次筛选，执行finalize方法

如果finalize方法后，可达性分析表示还是垃圾对象，那么会被回收

#### 执行引擎
